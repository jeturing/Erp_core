{% extends "base_admin.html" %}

{% block title %}Logs del Sistema - Jeturing Admin{% endblock %}
{% block page_title %}System Logs{% endblock %}
{% block page_subtitle %}Logs en tiempo real de provisioning y sistema{% endblock %}

{% block header_actions %}
<button id="refreshLogsBtn" class="flex items-center gap-2 bg-surface-dark hover:bg-surface-highlight text-white px-4 py-2 rounded-xl font-medium text-sm transition-all">
    <span class="material-symbols-outlined text-[20px]">refresh</span>
    <span>Actualizar</span>
</button>
<button class="flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-xl font-medium text-sm transition-all shadow-lg shadow-primary/25">
    <span class="material-symbols-outlined text-[20px]">download</span>
    <span>Exportar</span>
</button>
{% endblock %}

{% block content %}
<!-- Status Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="p-5 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-2">
            <div class="size-2 rounded-full bg-emerald-500 animate-pulse"></div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">PostgreSQL</p>
        </div>
        <p class="text-xl font-bold text-slate-900 dark:text-white">Healthy</p>
        <p class="text-slate-500 text-xs font-mono mt-1">5ms latency</p>
    </div>
    <div class="p-5 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-2">
            <div class="size-2 rounded-full bg-emerald-500"></div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">FastAPI</p>
        </div>
        <p class="text-xl font-bold text-slate-900 dark:text-white">Running</p>
        <p class="text-slate-500 text-xs font-mono mt-1">Port 4443</p>
    </div>
    <div class="p-5 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-2">
            <div class="size-2 rounded-full bg-emerald-500"></div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">LXC 105</p>
        </div>
        <p class="text-xl font-bold text-slate-900 dark:text-white">Active</p>
        <p class="text-slate-500 text-xs font-mono mt-1">sajet.us Container</p>
    </div>
    <div class="p-5 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-2">
            <div class="size-2 rounded-full bg-amber-500"></div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">Disk</p>
        </div>
        <p class="text-xl font-bold text-slate-900 dark:text-white" id="diskUsage">45%</p>
        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-1.5 mt-2">
            <div class="bg-amber-500 h-full rounded-full" style="width: 45%"></div>
        </div>
    </div>
</div>

<!-- Log Viewer -->
<div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-primary">terminal</span>
            <h3 class="font-bold text-slate-900 dark:text-white">Provisioning Logs</h3>
        </div>
        <div class="flex gap-2">
            <select id="logFilter" class="bg-surface-dark border border-slate-700 rounded-lg px-3 py-1.5 text-sm text-slate-300">
                <option value="all">Todos</option>
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
            </select>
        </div>
    </div>
    <div id="logContainer" class="h-96 overflow-y-auto p-4 bg-slate-950 font-mono text-sm">
        <div class="text-slate-500">[Cargando logs...]</div>
    </div>
</div>

<!-- Stripe Events -->
<div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-primary">receipt_long</span>
            <h3 class="font-bold text-slate-900 dark:text-white">Stripe Events Recientes</h3>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="border-b border-slate-100 dark:border-slate-800/50 bg-slate-50/50 dark:bg-surface-highlight/30 text-xs uppercase tracking-wide text-slate-500 font-semibold">
                    <th class="px-6 py-3">Event ID</th>
                    <th class="px-6 py-3">Tipo</th>
                    <th class="px-6 py-3">Procesado</th>
                    <th class="px-6 py-3">Fecha</th>
                </tr>
            </thead>
            <tbody id="stripeEventsBody" class="divide-y divide-slate-100 dark:divide-slate-800/50">
                <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-slate-500">Cargando eventos...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadLogs();
    loadStripeEvents();
});

document.getElementById('refreshLogsBtn').addEventListener('click', loadLogs);

async function loadLogs() {
    const container = document.getElementById('logContainer');
    // Placeholder - implementar API de logs
    container.innerHTML = `
        <div class="text-emerald-400">[2026-01-19 10:15:32] INFO: Provisioning started for subdomain: acme</div>
        <div class="text-emerald-400">[2026-01-19 10:15:33] INFO: Creating database sajet.us_acme...</div>
        <div class="text-emerald-400">[2026-01-19 10:15:35] INFO: Running pct exec 105 -- /opt/create_tenant.sh acme</div>
        <div class="text-amber-400">[2026-01-19 10:15:40] WARN: High memory usage detected (85%)</div>
        <div class="text-emerald-400">[2026-01-19 10:16:01] INFO: Tenant acme.sajet.us provisioned successfully</div>
        <div class="text-emerald-400">[2026-01-19 10:16:02] INFO: Cloudflare tunnel configured</div>
        <div class="text-slate-500">[2026-01-19 10:16:05] DEBUG: Webhook checkout.session.completed processed</div>
    `;
}

async function loadStripeEvents() {
    const body = document.getElementById('stripeEventsBody');
    try {
        const res = await fetch('/api/admin/stripe-events', {credentials: 'same-origin'});
        if (!res.ok) {
            body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">No hay eventos recientes</td></tr>';
            return;
        }
        const data = await res.json();
        body.innerHTML = data.events.map(e => `
            <tr class="hover:bg-surface-highlight/50">
                <td class="px-6 py-3 font-mono text-xs text-slate-400">${e.event_id}</td>
                <td class="px-6 py-3 text-sm">${e.event_type}</td>
                <td class="px-6 py-3">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${e.processed ? 'bg-emerald-500/10 text-emerald-400' : 'bg-amber-500/10 text-amber-400'}">
                        ${e.processed ? '✓ Sí' : '⏱ Pendiente'}
                    </span>
                </td>
                <td class="px-6 py-3 text-sm text-slate-400">${new Date(e.created_at).toLocaleString('es-ES')}</td>
            </tr>
        `).join('');
    } catch (err) {
        body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">Error al cargar eventos</td></tr>';
    }
}
</script>
{% endblock %}

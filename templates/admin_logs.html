{% extends "base_admin.html" %}

{% block title %}Logs del Sistema - Jeturing Admin{% endblock %}
{% block page_title %}System Logs{% endblock %}
{% block page_subtitle %}Logs en tiempo real de provisioning y sistema{% endblock %}

{% block header_actions %}
<button id="refreshLogsBtn" onclick="refreshAllLogs()" class="flex items-center gap-2 bg-surface-dark hover:bg-surface-highlight text-white px-4 py-2 rounded-xl font-medium text-sm transition-all">
    <span class="material-symbols-outlined text-[20px]">refresh</span>
    <span>Actualizar</span>
</button>
<button onclick="exportLogs()" class="flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-xl font-medium text-sm transition-all shadow-lg shadow-primary/25">
    <span class="material-symbols-outlined text-[20px]">download</span>
    <span>Exportar</span>
</button>
{% endblock %}

{% block content %}
<!-- Status Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="p-5 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-2">
            <div class="size-2 rounded-full bg-emerald-500 animate-pulse"></div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">PostgreSQL</p>
        </div>
        <p class="text-xl font-bold text-slate-900 dark:text-white">Healthy</p>
        <p class="text-slate-500 text-xs font-mono mt-1">5ms latency</p>
    </div>
    <div class="p-5 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-2">
            <div class="size-2 rounded-full bg-emerald-500"></div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">FastAPI</p>
        </div>
        <p class="text-xl font-bold text-slate-900 dark:text-white">Running</p>
        <p class="text-slate-500 text-xs font-mono mt-1">Port 4443</p>
    </div>
    <div class="p-5 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-2">
            <div class="size-2 rounded-full bg-emerald-500"></div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">LXC 105</p>
        </div>
        <p class="text-xl font-bold text-slate-900 dark:text-white">Active</p>
        <p class="text-slate-500 text-xs font-mono mt-1">sajet.us Container</p>
    </div>
    <div class="p-5 rounded-xl bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-2">
            <div class="size-2 rounded-full bg-amber-500"></div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">Disk</p>
        </div>
        <p class="text-xl font-bold text-slate-900 dark:text-white" id="diskUsage">45%</p>
        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-1.5 mt-2">
            <div class="bg-amber-500 h-full rounded-full" style="width: 45%"></div>
        </div>
    </div>
</div>

<!-- Log Viewer -->
<div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-primary">terminal</span>
            <h3 class="font-bold text-slate-900 dark:text-white">Provisioning Logs</h3>
        </div>
        <div class="flex gap-2">
            <select id="logFilter" class="bg-surface-dark border border-slate-700 rounded-lg px-3 py-1.5 text-sm text-slate-300">
                <option value="all">Todos</option>
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
            </select>
        </div>
    </div>
    <div id="logContainer" class="h-96 overflow-y-auto p-4 bg-slate-950 font-mono text-sm">
        <div class="text-slate-500">[Cargando logs...]</div>
    </div>
</div>

<!-- Stripe Events -->
<div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-primary">receipt_long</span>
            <h3 class="font-bold text-slate-900 dark:text-white">Stripe Events Recientes</h3>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="border-b border-slate-100 dark:border-slate-800/50 bg-slate-50/50 dark:bg-surface-highlight/30 text-xs uppercase tracking-wide text-slate-500 font-semibold">
                    <th class="px-6 py-3">Event ID</th>
                    <th class="px-6 py-3">Tipo</th>
                    <th class="px-6 py-3">Procesado</th>
                    <th class="px-6 py-3">Fecha</th>
                </tr>
            </thead>
            <tbody id="stripeEventsBody" class="divide-y divide-slate-100 dark:divide-slate-800/50">
                <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-slate-500">Cargando eventos...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentLogs = [];
let autoRefreshInterval = null;

document.addEventListener('DOMContentLoaded', () => {
    loadLogs();
    loadStripeEvents();
    loadSystemStatus();
    
    // Auto-refresh cada 30 segundos
    autoRefreshInterval = setInterval(() => {
        loadLogs();
        loadSystemStatus();
    }, 30000);
});

function refreshAllLogs() {
    loadLogs();
    loadSystemStatus();
    loadStripeEvents();
    toast.success('Logs actualizados');
}

function exportLogs() {
    if (currentLogs.length === 0) {
        toast.warning('No hay logs para exportar');
        return;
    }
    
    // Crear texto plano con los logs
    const text = currentLogs.map(log => log.line).join('\n');
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `logs_${new Date().toISOString().split('T')[0]}.log`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    toast.success(`Exportados ${currentLogs.length} líneas de log`);
}

async function loadLogs() {
    const container = document.getElementById('logContainer');
    const filter = document.getElementById('logFilter').value;
    container.innerHTML = '<div class="text-slate-500">[Cargando logs...]</div>';
    
    try {
        let url = '/api/logs/provisioning?lines=100';
        if (filter && filter !== 'all') {
            url += `&level=${filter}`;
        }
        
        const res = await fetch(url, {credentials: 'same-origin'});
        if (!res.ok) {
            if (res.status === 401) {
                window.location.href = '/login/admin';
                return;
            }
            throw new Error('Error cargando logs');
        }
        
        const data = await res.json();
        currentLogs = data.logs || []; // Guardar para exportar
        
        if (!data.logs || data.logs.length === 0) {
            container.innerHTML = '<div class="text-slate-500">[Sin logs recientes]</div>';
            return;
        }
        
        container.innerHTML = data.logs.map(log => 
            `<div class="${log.class}">${escapeHtml(log.line)}</div>`
        ).join('');
        
        // Scroll al final
        container.scrollTop = container.scrollHeight;
    } catch (err) {
        console.error('Error:', err);
        container.innerHTML = `<div class="text-rose-400">[Error cargando logs: ${err.message}]</div>`;
        toast.error('Error cargando logs');
    }
}

async function loadSystemStatus() {
    try {
        const res = await fetch('/api/logs/status', {credentials: 'same-origin'});
        if (!res.ok) return;
        
        const status = await res.json();
        
        // PostgreSQL
        const pgCard = document.querySelector('[data-service="postgresql"]') || 
                      document.querySelectorAll('.p-5.rounded-xl')[0];
        if (pgCard && status.postgresql) {
            const statusDot = pgCard.querySelector('.size-2');
            const statusText = pgCard.querySelector('.text-xl');
            const latencyText = pgCard.querySelector('.font-mono');
            
            if (status.postgresql.status === 'healthy') {
                statusDot.className = 'size-2 rounded-full bg-emerald-500 animate-pulse';
                statusText.textContent = 'Healthy';
                if (latencyText) latencyText.textContent = `${status.postgresql.latency_ms}ms latency`;
            } else {
                statusDot.className = 'size-2 rounded-full bg-rose-500';
                statusText.textContent = 'Error';
            }
        }
        
        // LXC 105
        const lxcCard = document.querySelectorAll('.p-5.rounded-xl')[2];
        if (lxcCard && status.lxc_105) {
            const statusDot = lxcCard.querySelector('.size-2');
            const statusText = lxcCard.querySelector('.text-xl');
            
            if (status.lxc_105.status === 'active') {
                statusDot.className = 'size-2 rounded-full bg-emerald-500';
                statusText.textContent = 'Active';
            } else {
                statusDot.className = 'size-2 rounded-full bg-amber-500';
                statusText.textContent = status.lxc_105.status || 'Unknown';
            }
        }
        
        // Disk
        const diskCard = document.querySelectorAll('.p-5.rounded-xl')[3];
        if (diskCard && status.disk) {
            const usageEl = document.getElementById('diskUsage');
            const progressBar = diskCard.querySelector('.bg-amber-500, .bg-emerald-500, .bg-rose-500');
            
            if (usageEl) usageEl.textContent = `${status.disk.usage_percent}%`;
            if (progressBar) {
                progressBar.style.width = `${status.disk.usage_percent}%`;
                // Cambiar color según uso
                if (status.disk.usage_percent > 80) {
                    progressBar.className = 'bg-rose-500 h-full rounded-full';
                } else if (status.disk.usage_percent > 60) {
                    progressBar.className = 'bg-amber-500 h-full rounded-full';
                } else {
                    progressBar.className = 'bg-emerald-500 h-full rounded-full';
                }
            }
        }
    } catch (err) {
        console.error('Error cargando status:', err);
    }
}

// Filtro de logs
document.getElementById('logFilter').addEventListener('change', loadLogs);

function escapeHtml(str = "") {
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

async function loadStripeEvents() {
    const body = document.getElementById('stripeEventsBody');
    try {
        const res = await fetch('/api/admin/stripe-events', {credentials: 'same-origin'});
        if (!res.ok) {
            body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">No hay eventos recientes</td></tr>';
            return;
        }
        const data = await res.json();
        
        if (!data.events || data.events.length === 0) {
            body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">No hay eventos recientes</td></tr>';
            return;
        }
        
        body.innerHTML = data.events.map(e => `
            <tr class="hover:bg-surface-highlight/50">
                <td class="px-6 py-3 font-mono text-xs text-slate-400">${e.event_id}</td>
                <td class="px-6 py-3 text-sm">${e.event_type}</td>
                <td class="px-6 py-3">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${e.processed ? 'bg-emerald-500/10 text-emerald-400' : 'bg-amber-500/10 text-amber-400'}">
                        ${e.processed ? '✓ Sí' : '⏱ Pendiente'}
                    </span>
                </td>
                <td class="px-6 py-3 text-sm text-slate-400">${new Date(e.created_at).toLocaleString('es-ES')}</td>
            </tr>
        `).join('');
    } catch (err) {
        body.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">Error al cargar eventos</td></tr>';
    }
}

// Limpiar interval al salir
window.addEventListener('beforeunload', () => {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}

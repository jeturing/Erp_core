<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>{% block title %}Jeturing Admin{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@500;600;700;800&family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <link rel="stylesheet" href="/static/css/brand.css">
    
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }
        ::-webkit-scrollbar-track.dark {
            background: #0b1220; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb.dark {
            background: #2a3b55; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }
        ::-webkit-scrollbar-thumb.dark:hover {
            background: #374b69; 
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        html.dark .glass-panel {
            background: rgba(22, 32, 50, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
    <script>
        // Cargar preferencia de tema al iniciar
        (function() {
            const stored = localStorage.getItem('darkMode');
            const darkMode = stored === null ? true : stored === 'true';
            if (darkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            if (stored === null) {
                localStorage.setItem('darkMode', 'true');
            }
        })();
    </script>
    {% block extra_head %}{% endblock %}
</head>
<body class="brand-shell text-slate-100 font-display transition-colors duration-200 antialiased overflow-hidden">
    <div class="grain"></div>
    <div class="flex h-screen w-full overflow-hidden relative">
        <!-- Sidebar -->
        {% include 'partials/admin_sidebar.html' %}
        
        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <!-- Header -->
            <header class="flex-shrink-0 z-20 px-8 pt-6">
                <div class="slim-nav flex items-center justify-between gap-4 px-6 py-3">
                    <div class="flex items-center gap-3">
                        <span class="status-dot"></span>
                        <div class="flex flex-col">
                            <h2 class="text-xl font-bold tracking-tight text-white">{% block page_title %}Dashboard{% endblock %}</h2>
                            <p class="text-sm text-slate-300">{% block page_subtitle %}Gestiona tu plataforma multitenant{% endblock %}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="chip hidden md:inline-flex">
                            <span class="material-symbols-outlined text-[16px] text-amber-300">bolt</span>
                            Control en vivo
                        </span>
                        {% block header_actions %}
                        <!-- Theme Toggle Button -->
                        <button id="themeToggle" class="btn-ghost size-10 rounded-2xl text-slate-200" title="Cambiar tema">
                            <span class="material-symbols-outlined text-[22px]" id="themeIcon">light_mode</span>
                        </button>
                        <button class="btn-ghost size-10 rounded-2xl text-slate-200 relative">
                            <span class="material-symbols-outlined text-[22px]">notifications</span>
                            <span class="absolute top-2 right-2 size-2 bg-accent-rose rounded-full border border-white/40"></span>
                        </button>
                        {% endblock %}
                    </div>
                </div>
            </header>
            
            <!-- Page Content -->
            <div class="flex-1 overflow-y-auto p-8 scroll-smooth relative">
                <div class="max-w-7xl mx-auto space-y-8 pb-10 hero-grid">
                    {% block content %}{% endblock %}
                </div>
            </div>
        </main>
    </div>

    <!-- Core JS Libraries -->
    <script src="/static/js/toast.js"></script>
    <script src="/static/js/global-search.js"></script>
    <script src="/static/js/export.js"></script>
    
    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        function updateThemeIcon() {
            if (document.documentElement.classList.contains('dark')) {
                themeIcon.textContent = 'light_mode';
            } else {
                themeIcon.textContent = 'dark_mode';
            }
        }
        
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isDark);
                updateThemeIcon();
            });
        }
        
        updateThemeIcon();

        // Logout function
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' });
            } catch (e) {
                console.warn('Logout API failed, clearing local state');
            }
            localStorage.removeItem('admin_token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_role');
            toast.info('Sesión cerrada correctamente');
            setTimeout(() => window.location.href = '/login/admin', 500);
        }

        // Interceptar fetch para agregar credentials y manejar errores
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const [resource, config] = args;
            if (typeof resource === 'string' && resource.startsWith('/api/')) {
                if (!config) args[1] = {};
                args[1].credentials = 'same-origin';
            }
            return originalFetch.apply(this, args).then(response => {
                // Redirigir a login si no autorizado
                if (response.status === 401 && typeof resource === 'string' && resource.startsWith('/api/')) {
                    console.warn('Session expired, redirecting to login');
                    window.location.href = '/login/admin';
                }
                return response;
            });
        };

        // Helper global para API calls con toast
        window.apiCall = async function(url, options = {}) {
            const loadingId = options.loading ? toast.loading(options.loading) : null;
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (loadingId) toast.dismiss(loadingId);
                
                if (!response.ok) {
                    throw new Error(data.detail || data.message || 'Error en la operación');
                }
                
                if (options.successMessage) {
                    toast.success(options.successMessage);
                }
                
                return data;
            } catch (error) {
                if (loadingId) toast.dismiss(loadingId);
                toast.error(error.message || 'Error de conexión');
                throw error;
            }
        };
    </script>
    {% block extra_scripts %}{% endblock %}
</body>
</html>
